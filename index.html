<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¸µê°„ì†ŒìŒ ë¡œê±° (í”„ë¡œí† íƒ€ì…)</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; padding: 20px; background: #f5f5f5; text-align: center; }
        .meter-container { width: 100%; height: 30px; background: #ddd; border-radius: 15px; overflow: hidden; margin: 20px 0; position: relative; }
        .meter-fill { height: 100%; width: 0%; background: #4caf50; transition: width 0.1s; }
        .threshold-line { position: absolute; top: 0; bottom: 0; width: 2px; background: red; z-index: 10; }
        .status { font-size: 2em; font-weight: bold; margin: 10px 0; }
        .log-area { text-align: left; background: white; padding: 15px; border-radius: 10px; height: 300px; overflow-y: scroll; border: 1px solid #ccc; }
        .log-item { border-bottom: 1px solid #eee; padding: 5px 0; font-size: 0.9em; color: #333; }
        .btn { padding: 15px 30px; font-size: 1.2em; background: #333; color: white; border: none; border-radius: 10px; cursor: pointer; width: 100%; }
        .controls { margin: 20px 0; padding: 15px; background: white; border-radius: 10px; }
    </style>
</head>
<body>

    <h2>ğŸ“¢ ì†ŒìŒ ê°ì§€ê¸° (Prototype)</h2>
    
    <div class="status"><span id="dbDisplay">0</span> dB</div>
    
    <div class="meter-container">
        <div class="meter-fill" id="meterFill"></div>
        <div class="threshold-line" id="thresholdLine" style="left: 50%;"></div>
    </div>

    <div class="controls">
        <label>ê°ì§€ ê¸°ì¤€: <span id="thresholdDisplay">50</span> dB</label>
        <input type="range" id="thresholdRange" min="0" max="100" value="50" style="width: 100%;">
        <p style="font-size: 0.8em; color: #666;">ì´ ìˆ˜ì¹˜ë¥¼ ë„˜ìœ¼ë©´ ë¡œê·¸ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
    </div>

    <button class="btn" id="startBtn" onclick="startMonitoring()">ê°ì§€ ì‹œì‘</button>

    <h3 style="text-align: left; margin-top: 30px;">ğŸ“‹ ê°ì§€ ë¡œê·¸</h3>
    <div class="log-area" id="logArea">
        <div class="log-item" style="color:#999;">ì•„ì§ ê¸°ë¡ëœ ì†ŒìŒì´ ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <script>
        let audioContext;
        let mediaStreamSource;
        let analyser;
        let isRunning = false;
        let lastLogTime = 0;
        
        // ê¸°ì¤€ê°’ ì„¤ì •
        const thresholdSlider = document.getElementById('thresholdRange');
        const thresholdLine = document.getElementById('thresholdLine');
        const thresholdDisplay = document.getElementById('thresholdDisplay');
        
        thresholdSlider.addEventListener('input', (e) => {
            thresholdDisplay.innerText = e.target.value;
            thresholdLine.style.left = e.target.value + '%';
        });

        async function startMonitoring() {
            if (isRunning) return;
            
            try {
                // ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                mediaStreamSource = audioContext.createMediaStreamSource(stream);
                mediaStreamSource.connect(analyser);
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
                
                isRunning = true;
                document.getElementById('startBtn').innerText = "ê°ì§€ ì¤‘... (ë§ì„ í•´ë³´ì„¸ìš”)";
                document.getElementById('startBtn').style.background = "#e74c3c";
                
                detectSound(dataArray);
                
            } catch (err) {
                alert("ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤! ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                console.error(err);
            }
        }

        function detectSound(dataArray) {
            if (!isRunning) return;
            
            requestAnimationFrame(() => detectSound(dataArray));
            analyser.getByteFrequencyData(dataArray);

            // ê°„ë‹¨í•œ ë³¼ë¥¨ ê³„ì‚° (RMS)
            let sum = 0;
            for(let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            let average = sum / dataArray.length;
            
            // ì‹¤ì œ dB ë³€í™˜ì€ ë³µì¡í•˜ì§€ë§Œ, ì—¬ê¸°ì„  0~100 ìŠ¤ì¼€ì¼ë¡œ ê·¼ì‚¬ì¹˜ ë§¤í•‘
            // ë³´í†µ ì›¹ ì˜¤ë””ì˜¤ API ê°’ì€ 0~255 ì‚¬ì´ì´ë¯€ë¡œ ë¹„ìœ¨ ì¡°ì •
            let approximateDb = Math.floor((average / 255) * 150); // ì¦í­ ê³„ìˆ˜ ì¡°ì •
            
            updateUI(approximateDb);
            checkThreshold(approximateDb);
        }

        function updateUI(db) {
            document.getElementById('dbDisplay').innerText = db;
            // 100dB ë„˜ì–´ê°€ë©´ 100ìœ¼ë¡œ ê³ ì •
            let percentage = Math.min(db, 100); 
            document.getElementById('meterFill').style.width = percentage + '%';
            
            // ìƒ‰ìƒ ë³€ê²½
            if(percentage > thresholdSlider.value) {
                document.getElementById('meterFill').style.backgroundColor = "#e74c3c"; // Red
            } else {
                document.getElementById('meterFill').style.backgroundColor = "#4caf50"; // Green
            }
        }

        function checkThreshold(db) {
            let threshold = parseInt(thresholdSlider.value);
            let now = Date.now();
            
            // ê¸°ì¤€ì¹˜ë¥¼ ë„˜ê³ , ë§ˆì§€ë§‰ ê¸°ë¡ í›„ 2ì´ˆê°€ ì§€ë‚¬ì„ ë•Œë§Œ ê¸°ë¡ (ë„ë°° ë°©ì§€)
            if (db > threshold && (now - lastLogTime > 2000)) {
                addLog(db);
                lastLogTime = now;
            }
        }

        function addLog(db) {
            const logArea = document.getElementById('logArea');
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ":" + 
                             now.getMinutes().toString().padStart(2, '0') + ":" + 
                             now.getSeconds().toString().padStart(2, '0');
            
            // ì²« ë¡œê·¸ë©´ ì•ˆë‚´ ë¬¸êµ¬ ì‚­ì œ
            if(logArea.children[0].innerText.includes("ì•„ì§")) {
                logArea.innerHTML = "";
            }

            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `<strong>â° ${timeString}</strong> - ğŸš¨ ì†ŒìŒ ê°ì§€: <span style="color:red; font-weight:bold;">${db} dB</span>`;
            
            logArea.prepend(logItem); // ìµœì‹ ìˆœ ìœ„ë¡œ
        }
    </script>
</body>
</html>